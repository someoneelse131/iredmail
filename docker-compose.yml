services:
  # ============================================================================
  # MariaDB Database
  # ============================================================================
  db:
    image: mariadb:10.11
    container_name: iredmail-db
    restart: unless-stopped
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      TZ: ${TZ:-UTC}
    volumes:
      - ./data/mysql:/var/lib/mysql
      - ./config/mariadb/custom.cnf:/etc/mysql/conf.d/99-custom.cnf:ro
      - ./data/backup/mysql:/backup
    networks:
      - iredmail-internal
    healthcheck:
      test: ["CMD", "healthcheck.sh", "--connect", "--innodb_initialized"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 60s
    command: >
      --character-set-server=utf8mb4
      --collation-server=utf8mb4_unicode_ci

  # ============================================================================
  # iRedMail Core (Mail + Web Services)
  # ============================================================================
  iredmail:
    build:
      context: .
      dockerfile: Dockerfile
    image: iredmail-custom:latest
    container_name: iredmail-core
    hostname: ${HOSTNAME}
    restart: unless-stopped
    depends_on:
      db:
        condition: service_healthy
    env_file:
      - .env
    ports:
      # SMTP
      - "25:25"
      - "465:465"
      - "587:587"
      # POP3 - disabled (not used)
      # - "110:110"
      # - "995:995"
      # IMAP
      - "143:143"
      - "993:993"
      # HTTP/HTTPS
      - "80:80"
      - "443:443"
      # ManageSieve
      - "4190:4190"
    volumes:
      # Mail storage
      - ./data/vmail:/var/vmail/vmail1
      # DKIM keys
      - ./data/dkim:/var/lib/dkim
      # SSL certificates
      - ./data/ssl:/etc/letsencrypt
      - ./data/certbot-www:/var/www/certbot:ro
      # Mailing lists
      - ./data/mlmmj:/var/vmail/mlmmj
      - ./data/mlmmj-archive:/var/vmail/mlmmj-archive
      # Sieve copies
      - ./data/imapsieve_copy:/var/vmail/imapsieve_copy
      # Custom configurations
      - ./config/postfix:/opt/iredmail/custom/postfix:ro
      - ./config/dovecot:/opt/iredmail/custom/dovecot:ro
      - ./config/amavis:/opt/iredmail/custom/amavis:ro
      - ./config/nginx:/opt/iredmail/custom/nginx:ro
      - ./config/roundcube:/opt/iredmail/custom/roundcube:ro
      - ./config/sogo:/opt/iredmail/custom/sogo:ro
      - ./config/iredadmin:/opt/iredmail/custom/iredadmin:ro
      # Runtime data
      - ./data/clamav:/var/lib/clamav
      - ./data/spamassassin:/var/lib/spamassassin
      - ./data/sogo:/var/lib/sogo
      - ./data/postfix-queue:/var/spool/postfix
      # Logs (shared with fail2ban)
      - ./data/logs:/var/log/iredmail
      # Persistent state
      - ./data/iredmail-state:/opt/iredmail/state
    networks:
      - iredmail-internal
      - iredmail-external
    cap_add:
      - NET_BIND_SERVICE
    sysctls:
      - net.ipv4.ip_unprivileged_port_start=0

  # ============================================================================
  # Fail2ban (Host Network for iptables access)
  # ============================================================================
  fail2ban:
    image: crazymax/fail2ban:latest
    container_name: iredmail-fail2ban
    restart: unless-stopped
    network_mode: host
    cap_add:
      - NET_ADMIN
      - NET_RAW
    volumes:
      - ./data/logs:/var/log/iredmail:ro
      - ./config/fail2ban:/data
    environment:
      TZ: ${TZ:-UTC}
      F2B_LOG_TARGET: STDOUT
      F2B_LOG_LEVEL: INFO
      F2B_DB_PURGE_AGE: 14d
    depends_on:
      - iredmail

  # ============================================================================
  # Certbot (SSL Certificate Management)
  # ============================================================================
  certbot:
    image: certbot/certbot:latest
    container_name: iredmail-certbot
    restart: unless-stopped
    volumes:
      - ./data/ssl:/etc/letsencrypt
      - ./data/certbot-www:/var/www/certbot
    entrypoint: "/bin/sh -c 'trap exit TERM; while :; do certbot renew --webroot --webroot-path=/var/www/certbot; sleep 12h & wait $${!}; done;'"
    depends_on:
      - iredmail

# =============================================================================
# Networks
# =============================================================================
networks:
  iredmail-internal:
    driver: bridge
    internal: true
  iredmail-external:
    driver: bridge

# =============================================================================
# Volume Definitions (using bind mounts for easy access)
# =============================================================================
# All data is stored in ./data/ directory for easy backup and management
